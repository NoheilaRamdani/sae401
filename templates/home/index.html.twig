{% extends 'base.html.twig' %}

{% block title %}Accueil - Cahier de texte{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                events: '/api/assignments' + (new URLSearchParams(window.location.search).toString() ? '?' + new URLSearchParams(window.location.search).toString() : ''),
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    fetch(`/api/assignments/${info.event.id}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('ID cliqué:', info.event.id);
                            console.log('Data from API:', data);
                            showEventDetails(data);
                        });
                }
            });
            calendar.render();

            document.querySelectorAll('.event-item').forEach(item => {
                // Vérifier si la case est cochée au chargement et appliquer la classe correspondante
                const checkbox = item.querySelector('input[type="checkbox"]');
                const checkEnabledElements = item.querySelectorAll('.check-enabled'); // Cibler tous les éléments avec la classe .check-enabled
                if (checkbox && checkEnabledElements.length > 0) {
                    // Si la case est cochée, ajouter la classe "completed-task" à tous les éléments .check-enabled
                    if (checkbox.checked) {
                        checkEnabledElements.forEach(element => {
                            element.classList.add('completed-task');
                        });
                    }

                    // Ajouter un événement pour gérer le changement de l'état de la case
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const eventId = this.dataset.id;
                        fetch(`/api/assignments/${eventId}/toggle-complete`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                const calendarEvent = calendar.getEventById(eventId);
                                if (calendarEvent) {
                                    calendarEvent.setProp('classNames', data.isCompleted ? ['completed-event'] : []);
                                }

                                // Ajouter ou enlever la classe "completed-task" à tous les éléments .check-enabled selon l'état de la case
                                checkEnabledElements.forEach(element => {
                                    if (data.isCompleted) {
                                        element.classList.add('completed-task');
                                    } else {
                                        element.classList.remove('completed-task');
                                    }
                                });
                            });
                    });
                }

                // Ajouter l'événement de clic pour afficher les détails de l'événement
                item.addEventListener('click', function(e) {
                    if (e.target.tagName === 'INPUT') {
                        e.stopPropagation();
                        return;
                    }
                    const eventId = this.dataset.id;
                    fetch(`/api/assignments/${eventId}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('ID cliqué:', eventId);
                            console.log('Data from API:', data);
                            showEventDetails(data);
                        });
                });
            });

            function showEventDetails(event) {
                console.log('Event passé à showEventDetails:', event);

                document.getElementById('modalTitle').textContent = event.title || 'Sans titre';
                document.getElementById('modalDate').textContent = new Date(event.start).toLocaleString('fr-FR') || 'Date inconnue';
                document.getElementById('modalDescription').textContent = event.description || 'Aucune description';

                document.getElementById('modalSubjectCode').textContent = event.subject?.code || 'Non spécifié';
                document.getElementById('modalSubjectName').textContent = event.subject?.name || 'Non spécifié';

                const submissionUrlEl = document.getElementById('modalSubmissionUrl');
                if (event.submissionUrl) {
                    submissionUrlEl.innerHTML = `<a href="${event.submissionUrl}" target="_blank">${event.submissionUrl}</a>`;
                } else {
                    submissionUrlEl.textContent = 'Aucune URL de rendu';
                }

                const submissionTypeDisplay = (event.submissionType && event.submissionType.toLowerCase() === 'other') ? 'Autre' : event.submissionType || 'Non spécifié';
                document.getElementById('modalSubmissionType').textContent = submissionTypeDisplay;

                const submissionOtherContainer = document.getElementById('modalSubmissionOtherContainer');
                if (event.submissionType && event.submissionType.toLowerCase() === 'other' && event.submissionOther) {
                    document.getElementById('modalSubmissionOther').textContent = event.submissionOther;
                    submissionOtherContainer.style.display = 'block';
                } else {
                    submissionOtherContainer.style.display = 'none';
                }

                //document.getElementById('modalCourseLocation').textContent = event.courseLocation || 'Non spécifié';
                document.getElementById('modalType').textContent = event.type || 'Non spécifié';
                document.getElementById('modalCompleted').checked = event.isCompleted || false;
                document.getElementById('eventModal').dataset.id = event.id;

                //document.getElementById('modalSubjectInstruction').textContent = event.courseLocation || 'Non spécifié';
                document.getElementById('modalSubmissionInstruction').textContent = submissionTypeDisplay;

                const editAssignmentLink = document.getElementById('editAssignment');
                if (editAssignmentLink) {
                    editAssignmentLink.href = `/assignments/${event.id}/edit`;
                }

                document.getElementById('eventModal').style.display = 'flex';
            }

            const suggestModificationBtn = document.getElementById('suggestModification');
            if (suggestModificationBtn) {
                suggestModificationBtn.addEventListener('click', function() {
                    const eventId = document.getElementById('eventModal').dataset.id;
                    window.location.href = `/assignments/${eventId}/suggest-modification-form`;
                });
            }

            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('eventModal').style.display = 'none';
            });

            document.getElementById('modalCompleted').addEventListener('change', function() {
                const eventId = document.getElementById('eventModal').dataset.id;
                fetch(`/api/assignments/${eventId}/toggle-complete`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        const listItem = document.querySelector(`div[data-id="${eventId}"]`);
                        if (listItem) {
                            listItem.querySelector('input[type="checkbox"]').checked = data.isCompleted;
                        }
                        const calendarEvent = calendar.getEventById(eventId);
                        if (calendarEvent) {
                            calendarEvent.setProp('classNames', data.isCompleted ? ['completed-event'] : []);
                        }
                    });
            });

            const notifications = {{ notifications|json_encode|raw }};
            notifications.forEach(notification => {
                const div = document.createElement('div');
                div.textContent = `Attention : "${notification.title}" dans ${notification.hoursUntilDue}h !`;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 5000);
            });

            const suggestionsBox = document.querySelector('div[data-suggestions]');
            const showSuggestionsBtn = document.querySelector('button[data-show-suggestions]');
            if (suggestionsBox && showSuggestionsBtn) {
                const isHidden = localStorage.getItem('suggestionsBoxHidden') === 'true';
                if (isHidden) {
                    suggestionsBox.style.display = 'none';
                    showSuggestionsBtn.style.display = 'block';
                }

                document.getElementById('closeSuggestions').addEventListener('click', function() {
                    suggestionsBox.style.display = 'none';
                    showSuggestionsBtn.style.display = 'block';
                    localStorage.setItem('suggestionsBoxHidden', 'true');
                });

                showSuggestionsBtn.addEventListener('click', function() {
                    suggestionsBox.style.display = 'block';
                    showSuggestionsBtn.style.display = 'none';
                    localStorage.setItem('suggestionsBoxHidden', 'false');
                });

                function updateSuggestions() {
                    fetch('/api/suggestions/pending')
                        .then(response => response.json())
                        .then(data => {
                            const suggestionsList = suggestionsBox.querySelector('ul');
                            if (!suggestionsList) return;

                            suggestionsList.innerHTML = '';
                            data.forEach(suggestion => {
                                const li = document.createElement('li');
                                li.dataset.id = suggestion.id;
                                li.innerHTML = `<strong>${suggestion.suggestedBy}</strong> pour "[${suggestion.assignment.subjectCode}] ${suggestion.assignment.title}" : ${suggestion.message}`;
                                suggestionsList.appendChild(li);
                            });

                            if (data.length === 0) {
                                suggestionsBox.style.display = 'none';
                                showSuggestionsBtn.style.display = 'block';
                                localStorage.setItem('suggestionsBoxHidden', 'true');
                            }
                        });
                }

                updateSuggestions();
                document.addEventListener('suggestionProcessed', updateSuggestions);
            }
        });
    </script>
{% endblock %}

{% block body %}
    <main class="home">
        <h1>Calendrier des tâches</h1>

        <div class="calendar-container">
            <form method="get">
                <label for="type">Filtrer par type :</label>
                <select name="type" id="type" onchange="this.form.submit()">
                    <option value="">Tous</option>
                    <option value="devoir" {{ type_filter == 'devoir' ? 'selected' }}>Devoir</option>
                    <option value="examen" {{ type_filter == 'examen' ? 'selected' }}>Examen</option>
                    <option value="oral" {{ type_filter == 'oral' ? 'selected' }}>Oral</option>
                </select>
            </form>
            <div id="calendar"></div>
        </div>
        <div class="tasks-container">
            <div class="main-content column-start-start">
                <h2><i class="fa-solid fa-calendar"></i> A venir</h2>

                {% if assignments_data|length > 0 %}
                    {% for data in assignments_data %}
                        {% set assignment = data.assignment %}
                        {% set now = "now"|date('U') %}
                        {% set dueDate = assignment.dueDate|date('U') %}
                        {% set daysUntilDue = (dueDate - now) / (60 * 60 * 24) %}
                        {% set daysUntilDue = daysUntilDue|round(0, 'floor') %}

                        <div data-id="{{ assignment.id }}" class="event-item task-container column-start">
                            <span class="color"></span>
                            <div class="top row-start">
                                <p class="date">{{ assignment.dueDate|date('d/m/Y - H:i') }}</p>
                                <p class="tag-small">{{ assignment.type|capitalize }}</p>
                            </div>
                            <div class="content row-spacebtwn">
                                <div class="task row-start">
                                    <input type="checkbox" data-id="{{ assignment.id }}" {{ data.isCompleted ? 'checked' }}>
                                    <div class="details column-start">
                                        <p class="check-enabled name">
                                            {{ assignment.title }}
                                        </p>
                                        <p class="check-enabled subject">[{{ data.subjectCode }}] - {{ assignment.subject.name }}</p>
                                    </div>
                                </div>
                                <div class="countdown row-start">
                                    <i class="check-enabled fa-solid fa-clock ontime"></i>
                                    <p class="check-enabled">{{ daysUntilDue >= 0 ? daysUntilDue ~ ' jour' ~ (daysUntilDue > 1 ? 's' : '') ~ ' ' : 'Expiré' }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Aucun devoir à venir.</p>
                {% endif %}
            </div>
            <a class="button-grey" href="{{ path('app_assignments_history') }}"><i class="fa-solid fa-clock-rotate-left"></i> Historique des tâches</a>
        </div>


    <div id="eventModal" class="modal-container" style="display: none;">
        <div class="modal">
            <button id="closeModal"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="modalTitle"></h3>
            <ul>
                <li id="modalType" class="tag"></li>
                <li class="title"><i class="fa-solid fa-bookmark"></i> Matière</li>
                <li><span id="modalSubjectCode"></span> - <span id="modalSubjectName"></span></li>
                <li class="title"><i class="fa-solid fa-calendar-day"></i> Date</li>
                <li id="modalDate"></li>
                <li class="title"><i class="fa-solid fa-file-lines"></i> Description</li>
                <li id="modalDescription"></li>
                <li class="plateformes">
                    <span class="title"><i class="fa-solid fa-layer-group"></i> Consignes et rendu</span>
                    <ul>
                        <li>- <span class="subtitle">Sujet</span> : <span id="modalSubmissionType"></span></li>
                        <li>- <span  class="subtitle">Mode de rendu</span> : <span id="modalSubmissionInstruction"></span></li>
                        <li id="modalSubmissionOtherContainer" style="display: none;"><span  class="subtitle">Précision</span> : <span id="modalSubmissionOther"></span></li>

                        <li>- <span  class="subtitle">URL de rendu</span> : <span id="modalSubmissionUrl"></span></li>

                    </ul>
                </li>
                <div class="done">
                    <input type="checkbox" id="modalCompleted" name="done" />
                    <label for="done">Fait</label>
                </div>
            </ul>

            <!--
                        <p id="modalSubmissionOtherContainer" style="display: none;">
                <strong>Précision :</strong> <span id="modalSubmissionOther"></span>
            </p>
            <li>- <span class="subtitle">Sujet</span> : <span id="modalSubjectInstruction"></span></li>
            <p><strong>Où trouver le cours :</strong> <span id="modalCourseLocation"></span></p> -->


            {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_DELEGATE') %}
                <a class="button" href="" id="editAssignment"><i class="fa-solid fa-pencil"></i> Modifier le devoir</a>
            {% else %}
                <button class="button" id="suggestModification"><i class="fa-solid fa-pencil"></i> Suggérer une modification</button>
            {% endif %}
        </div>
    </div>

    </main>

    {% if is_granted('ROLE_DELEGATE') %}
        <div data-suggestions>
            <h4>
                <span>Suggestions de modifications</span>
                <button id="closeSuggestions">Fermer</button>
            </h4>
            <ul>
                {% for suggestion in suggestions %}
                    <li data-id="{{ suggestion.id }}">
                        <strong>{{ suggestion.suggestedBy.userIdentifier }}</strong> pour "[{{ suggestion.assignment.subject.code }}] {{ suggestion.assignment.title }}" : {{ suggestion.message }}
                    </li>
                {% endfor %}
            </ul>
            <a href="{{ path('app_suggestions') }}">Voir l'historique complet</a>
        </div>
        <button data-show-suggestions>Afficher les suggestions</button>
    {% endif %}

{% endblock %}