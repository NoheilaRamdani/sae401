{% extends 'base.html.twig' %}

{% block title %}Calendrier{% endblock %}
{% block description %}Découvrez l’agenda MMI pour gérer vos devoirs et organiser vos tâches !{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                buttonText: {
                    today: 'Aujourd\'hui'
                },
                events: '/api/assignments' + (new URLSearchParams(window.location.search).toString() ? '?' + new URLSearchParams(window.location.search).toString() : ''),
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    fetch(`/api/assignments/${info.event.id}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur API: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('ID cliqué:', info.event.id);
                            console.log('Data from API:', data);
                            showEventDetails(data);
                        })
                        .catch(error => {
                            console.error('Erreur lors de la récupération des détails:', error);
                            alert('Impossible de charger les détails de l\'événement.');
                        });
                },
                eventDidMount: function(info) {
                    info.el.classList.add('check-enabled');
                    info.el.dataset.id = info.event.id; // Ajouter data-id pour la sélection
                }
            });
            calendar.render();

            // Initialiser la gestion des tâches terminées
            initTaskManager({
                selector: '.task-container',
                hasCalendar: true,
                calendar: calendar
            });

            document.querySelectorAll(".group-btn").forEach(button => {
                button.addEventListener("click", function () {
                    const type = this.dataset.type;
                    const url = new URL(window.location);
                    if (type) {
                        url.searchParams.set("type", type);
                    } else {
                        url.searchParams.delete("type");
                    }
                    window.location.href = url.toString();
                });
            });

            // Fonction pour ajuster la position de .tasks-container en fonction de la hauteur visible de la nav
            function adjustTasksContainerPosition() {
                const tasksContainer = document.querySelector('.tasks-container');
                const nav = document.querySelector('nav');

                if (tasksContainer && nav && window.innerWidth >= 1200) {
                    // Calculer la position de la nav par rapport à la fenêtre
                    const navRect = nav.getBoundingClientRect();

                    // La hauteur visible de la nav est la différence entre la position en bas de la nav et la position en haut de la fenêtre
                    const navVisibleHeight = Math.max(0, Math.min(navRect.bottom, window.innerHeight) - Math.max(0, navRect.top));

                    // Appliquer le padding-top à .tasks-container en fonction de la hauteur visible de la nav
                    const currentPaddingTop = 30; // Valeur fixe que tu as définie pour le padding
                    tasksContainer.style.paddingTop = (navVisibleHeight + currentPaddingTop) + 'px';
                } else if (tasksContainer) {
                    // Réinitialiser le padding-top pour les écrans < 1200px
                    tasksContainer.style.paddingTop = '30px';
                }
            }

            // Ajouter un écouteur d'événements pour recalculer à chaque scroll
            window.addEventListener('scroll', adjustTasksContainerPosition);

            // Appeler la fonction une première fois pour initialiser la position
            adjustTasksContainerPosition();

            const notifications = {{ notifications|json_encode|raw }};
            notifications.forEach(notification => {
                const div = document.createElement('div');
                div.textContent = `Attention : "${notification.title}" dans ${notification.hoursUntilDue}h !`;
                div.classList.add('popup');
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            });

            const suggestionsBox = document.querySelector('div[data-suggestions]');
            const showSuggestionsBtn = document.querySelector('button[data-show-suggestions]');
            if (suggestionsBox && showSuggestionsBtn) {
                const isHidden = localStorage.getItem('suggestionsBoxHidden') === 'true';
                if (isHidden) {
                    suggestionsBox.style.display = 'none';
                    showSuggestionsBtn.style.display = 'flex';
                } else {
                    suggestionsBox.style.display = 'block';
                    showSuggestionsBtn.style.display = 'none';
                }

                document.getElementById('closeSuggestions').addEventListener('click', function() {
                    suggestionsBox.style.display = 'none';
                    showSuggestionsBtn.style.display = 'flex';
                    localStorage.setItem('suggestionsBoxHidden', 'true');
                });

                showSuggestionsBtn.addEventListener('click', function() {
                    suggestionsBox.style.display = 'block';
                    showSuggestionsBtn.style.display = 'none';
                    localStorage.setItem('suggestionsBoxHidden', 'false');
                });

                function updateSuggestions() {
                    fetch('/api/suggestions/pending', {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            const suggestionsList = suggestionsBox.querySelector('ul');
                            if (!suggestionsList) return;

                            suggestionsList.innerHTML = '';
                            data.forEach(suggestion => {
                                const li = document.createElement('li');
                                li.dataset.id = suggestion.id;
                                li.innerHTML = `
                                    <a href="/suggestion/${suggestion.id}/review"><strong>${suggestion.suggestedBy}</strong> pour "[${suggestion.assignment.subjectCode}] ${suggestion.assignment.title}" : ${suggestion.message || 'Aucun message'}</a>
                                `;
                                suggestionsList.appendChild(li);
                            });

                            if (data.length === 0) {
                                suggestionsBox.style.display = 'none';
                                showSuggestionsBtn.style.display = 'flex';
                                localStorage.setItem('suggestionsBoxHidden', 'true');
                            } else {
                                suggestionsBox.style.display = 'block';
                                showSuggestionsBtn.style.display = 'none';
                                localStorage.setItem('suggestionsBoxHidden', 'false');
                            }
                        })
                        .catch(error => console.error('Erreur lors du chargement des suggestions :', error));
                }

                const fontAwesomeLoaded = document.querySelector('link[href*="font-awesome"]') || document.querySelector('link[href*="fontawesome"]');
                if (!fontAwesomeLoaded) {
                    showSuggestionsBtn.classList.add('no-icon');
                }

                updateSuggestions();
                document.addEventListener('suggestionProcessed', updateSuggestions);
            }
        });
    </script>
{% endblock %}
{% block body %}
    <main class="home">
        <div class="calendar-container">
            <h1 class="sr-only">Calendrier des tâches</h1>

            <div class="group-buttons-container">
                <div class="group-buttons">
                    <button class="group-btn {{ type_filter == '' ? 'current' }}" data-type="">Tous</button>
                    <button class="group-btn {{ type_filter == 'devoir' ? 'current' }}" data-type="devoir">Devoir</button>
                    <button class="group-btn {{ type_filter == 'examen' ? 'current' }}" data-type="examen">Examen</button>
                    <button class="group-btn {{ type_filter == 'oral' ? 'current' }}" data-type="oral">Oral</button>
                </div>
            </div>
            <div id="calendar"></div>
        </div>

        <div class="tasks-container">
            <div class="main-content column-start-start">
                <h2><i class="fa-solid fa-calendar"></i> A venir</h2>

                {% if assignments_data|length > 0 %}
                    {% for data in assignments_data %}
                        {% set assignment = data.assignment %}
                        {% set now = "now"|date('U') %}
                        {% set dueDate = assignment.dueDate|date('U') %}
                        {% set daysUntilDue = (dueDate - now) / (60 * 60 * 24) %}
                        {% set daysUntilDue = daysUntilDue|round(0, 'floor') %}

                        <div data-id="{{ assignment.id }}" class="event-item task-container column-start {{ data.urgencyClass }}">
                            <span class="color" style="background-color: {{ data.color }}"></span>
                            <div class="top row-start">
                                <p class="date">{{ assignment.dueDate|date('d/m/Y - H:i') }}</p>
                                <p class="tag-small">{{ assignment.type|capitalize }}</p>
                            </div>
                            <div class="content row-spacebtwn">
                                <div class="task row-start">
                                    <input aria-label="Tâche faite" type="checkbox" data-id="{{ assignment.id }}" {{ data.isCompleted ? 'checked' }}>
                                    <div class="details column-start">
                                        <p class="check-enabled name">
                                            {{ assignment.title }}
                                        </p>
                                        <p class="check-enabled subject">[{{ data.subjectCode }}] {{ assignment.subject.name }}</p>
                                    </div>
                                </div>
                                <div class="countdown row-start">
                                    <i class="check-enabled fa-solid fa-clock {{ data.urgencyClass }}"></i>
                                    <p class="check-enabled {{ data.hoursUntilDue < 24 and data.hoursUntilDue >= 0 ? 'urgent-time' : '' }}">
                                        {% if data.hoursUntilDue < 0 %}
                                            Expiré
                                        {% elseif data.hoursUntilDue < 24 %}
                                            {{ data.hoursUntilDue }} heure{{ data.hoursUntilDue > 1 ? 's' : '' }}
                                        {% else %}
                                            {{ daysUntilDue }} jour{{ daysUntilDue > 1 ? 's' : '' }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Aucun devoir à venir.</p>
                {% endif %}
            </div>
            <a class="button-grey" href="{{ path('app_assignments_history') }}"><i class="fa-solid fa-clock-rotate-left"></i> Historique des tâches</a>
        </div>

        {% include 'partials/modal.html.twig' %}

        {% if is_granted('ROLE_DELEGATE') %}
            <div class="notif-container" data-suggestions>
                <h3 class="row-spacebtwn h4">
                    Suggestions de modifications
                    <button aria-label="Fermer" id="closeSuggestions"><i class="fa-solid fa-xmark"></i></button>
                </h3>
                <ul></ul>
                <div class="link row-end">
                    <a class="row-end" href="{{ path('app_suggestions') }}"><i class="fa-solid fa-arrow-right"></i> Voir l'historique complet</a>
                </div>
            </div>
            <button class="notif-button" data-show-suggestions title="Afficher les suggestions">
                <i class="fa-solid fa-bell"></i>
                <span class="sr-only">Afficher les suggestions</span>
            </button>
        {% endif %}
    </main>
{% endblock %}