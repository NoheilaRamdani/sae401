{% extends 'base.html.twig' %}

{% block title %}Historique des suggestions{% endblock %}
{% block description %}Retrouvez ici toutes les suggestions qui vous ont été soumises{% endblock %}


{% block body %}
    <main class="padding">
        <h1>Historique des suggestions</h1>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">{{ message }}</div>
            {% endfor %}
        {% endfor %}

        {% if suggestionsData|length > 0 %}
            <table class="suggestions-table">
                <thead>
                <tr>
                    <th>Suggéré par</th>
                    <th>Devoir</th>
                    <th>Message</th>
                    <th>Changements proposés</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                {% for data in suggestionsData %}
                    {% set suggestion = data.suggestion %}
                    <tr>
                        <td class="suggested-by">{{ suggestion.suggestedBy.userIdentifier }}</td>
                        <td class="assignment-info">[{{ suggestion.assignment.subject.code }}] {{ suggestion.assignment.title }}</td>
                        <td class="message">{{ suggestion.message|default('Aucun message') }}</td>
                        <td class="changes">
                            {% if suggestion.proposedChanges|length > 0 %}
                                {% for field, value in suggestion.proposedChanges %}
                                    {% if field == 'title' %}
                                        Titre : {{ suggestion.assignment.title|default('Aucun') }} → {{ value|default('Aucun') }}<br>
                                    {% elseif field == 'description' %}
                                        Description : {{ suggestion.assignment.description|default('Aucune') }} → {{ value|default('Aucune') }}<br>
                                    {% elseif field == 'due_date' %}
                                        Date limite : {{ suggestion.assignment.dueDate ? suggestion.assignment.dueDate|date('d/m/Y H:i') : 'Non défini' }} → {{ value ? (value|date('d/m/Y H:i')) : 'Non défini' }}<br>
                                    {% elseif field == 'type' %}
                                        Type : {{ suggestion.assignment.type|default('Aucun') }} → {{ value|default('Aucun') }}<br>
                                    {% elseif field == 'submission_type' %}
                                        Mode de rendu : {{ suggestion.assignment.submissionType|default('Aucun') }} → {{ value|default('Aucun') }}<br>
                                    {% elseif field == 'submission_url' %}
                                        URL de rendu : {{ suggestion.assignment.submissionUrl|default('Aucune') }} → {{ value|default('Aucune') }}<br>
                                    {% elseif field == 'submission_other' %}
                                        Autres instructions : {{ suggestion.assignment.submissionOther|default('Aucune') }} → {{ value|default('Aucune') }}<br>
                                    {% elseif field == 'course_location' %}
                                        Lieu du cours : {{ suggestion.assignment.courseLocation|default('Aucun') }} → {{ value|default('Aucun') }}<br>
                                    {% elseif field == 'subject_id' %}
                                        Matière : {{ suggestion.assignment.subject.name|default('Non défini') }} → {{ data.proposedSubject ? data.proposedSubject.name : 'Non défini' }}<br>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                Aucun changement proposé.
                            {% endif %}
                        </td>
                        <td>{{ suggestion.createdAt|date('d/m/Y H:i') }}</td>
                        <td>
                            {% if suggestion.isProcessed %}
                                <span class="status-processed">Traité</span>
                            {% else %}
                                <span class="status-pending">En attente</span>
                            {% endif %}
                        </td>
                        <td class="action">
                            {% if not suggestion.isProcessed %}
                                <a href="{{ path('review_suggestion', {'id': suggestion.id}) }}" class="btn btn-primary">Traiter</a>
                            {% else %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="no-suggestions">Aucune suggestion à afficher.</p>
        {% endif %}

        <a href="{{ path('app_home') }}" class="btn btn-sec">Retour à l'accueil</a>
    </main>
{% endblock %}