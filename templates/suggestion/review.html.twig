{% extends 'base.html.twig' %}

{% block title %}Revoir la suggestion - {{ assignment.title }}{% endblock %}
{% block description %}Une erreur potentielle dans une tâche ? Consulter la suggestion de modification{% endblock %}

{% block body %}
    <main class="suggest-assignment modal-container padding container row-center has-table">
        <div class="modal">
            <h1>Revoir la suggestion pour "{{ assignment.title }}"</h1>

            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label }}">{{ message }}</div>
                {% endfor %}
            {% endfor %}
            <ul>
                <li class="title">Suggéré par :</li>
                <li>{{ suggestion.suggestedBy.firstName }} {{ suggestion.suggestedBy.lastName }}</li>
                <li class="title">Message :</li>
                <li>{{ suggestion.message|default('Aucun message fourni.') }}</li>
            </ul>

            <h2>Changements proposés</h2>
            {% set hasChanges = false %}
            {% set differences = [] %}

            {% set fields = {
                'title': {
                    'label': 'Titre',
                    'current': suggestion.originalValues.title|default(assignment.title|default('')),
                    'proposed': suggestion.proposedChanges.title|default(assignment.title|default(''))
                },
                'description': {
                    'label': 'Description',
                    'current': suggestion.originalValues.description|default(assignment.description|default('')),
                    'proposed': suggestion.proposedChanges.description|default(assignment.description|default(''))
                },
                'due_date': {
                    'label': 'Date limite',
                    'current': suggestion.originalValues.due_date|default(assignment.dueDate ? assignment.dueDate|date('Y-m-d H:i:s') : ''),
                    'proposed': suggestion.proposedChanges.due_date|default(assignment.dueDate ? assignment.dueDate|date('Y-m-d H:i:s') : '')
                },
                'type': {
                    'label': 'Type',
                    'current': suggestion.originalValues.type|default(assignment.type|default('')),
                    'proposed': suggestion.proposedChanges.type|default(assignment.type|default(''))
                },
                'submission_url': {
                    'label': 'URL de rendu',
                    'current': suggestion.originalValues.submission_url|default(assignment.submissionUrl|default('')),
                    'proposed': suggestion.proposedChanges.submission_url|default(assignment.submissionUrl|default(''))
                },
                'submission_other': {
                    'label': 'Autres instructions',
                    'current': suggestion.originalValues.submission_other|default(assignment.submissionOther|default('')),
                    'proposed': suggestion.proposedChanges.submission_other|default(assignment.submissionOther|default(''))
                },
                'subject_id': {
                    'label': 'Matière',
                    'current': originalSubject ? originalSubject.name : (assignment.subject ? assignment.subject.name : 'Non défini'),
                    'proposed': proposedSubject ? proposedSubject.name : (assignment.subject ? assignment.subject.name : 'Non défini')
                }
            } %}

            {% for field, data in fields %}
                {# Comparer les valeurs directement, en évitant une normalisation excessive #}
                {% if data.current != data.proposed %}
                    {% set hasChanges = true %}
                    {% set differences = differences|merge([{
                        'field': data.label,
                        'current': data.current == '' ? 'Non défini' : data.current,
                        'proposed': data.proposed == '' ? 'Non défini' : data.proposed
                    }]) %}
                {% endif %}
            {% endfor %}

            {% if hasChanges %}
                <table class="difference-table">
                    <thead>
                    <tr>
                        <th>Champ</th>
                        <th>Valeur actuelle</th>
                        <th>Valeur proposée</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for diff in differences %}
                        <tr>
                            <td>{{ diff.field }}</td>
                            <td class="current-value">{{ diff.current }}</td>
                            <td class="proposed-value">{{ diff.proposed }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="no-changes">Aucune modification détectée. Cette suggestion ne propose aucun changement par rapport aux valeurs actuelles.</p>
            {% endif %}

            {% if suggestion.status == 'PENDING' %}
                {{ form_start(form) }}
                <div class="row-start">
                    {{ form_widget(form.approve) }}
                    {{ form_widget(form.reject) }}
                </div>
                {{ form_end(form) }}
            {% endif %}

            <a href="{{ path('app_suggestions') }}" class="button btn btn-sec">Retour aux suggestions</a>
        </div>
    </main>
{% endblock %}