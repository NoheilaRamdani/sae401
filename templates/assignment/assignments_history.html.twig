{% extends 'base.html.twig' %}

{% block title %}Tâches{% endblock %}
{% block body %}

    <main class="all-tasks">

        <div class="filter-section">

            <div class="filter-container">
                <h1>Toutes les tâches</h1>
                <div class="filter">
                    <label for="subjectSelect">Sélectionner une matière</label>
                    <select id="subjectSelect">
                        <option value="">Toutes les matières</option>
                        {% if subjects is defined and subjects|length > 0 %}
                            {% for subject in subjects %}
                                <option value="{{ subject.name }}">{{ subject.name }}</option>
                            {% endfor %}
                        {% else %}
                            <option disabled>Aucune matière disponible</option>
                        {% endif %}
                    </select>
                </div>

                {% if is_delegate_or_admin %}
                    <div class="filter">
                        <label for="groupSelect">Sélectionner un groupe</label>
                        <select id="groupSelect">
                            <option value="">Tous les groupes</option>
                            {% if groups is defined and groups|length > 0 %}
                                {% for group in groups %}
                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>Aucun groupe disponible</option>
                            {% endif %}
                        </select>
                    </div>
                {% endif %}
                <button class="button-grey" onclick="filterAssignments()"><i class="fa-solid fa-filter"></i> Filtrer</button>
            </div>


            <a class="button back-btn" href="/"><i class="fa-solid fa-arrow-left"></i> Retour à l'accueil</a>

        </div>


        <div id="assignmentsContainer" class="column-start">
            {% if assignments|length > 0 %}
                {% for assignment in assignments %}
                    <div class="task-container column-start">
                        <span class="color"></span>
                        <div class="top row-start">
                            <p class="date">{{ assignment.dueDate|date('d/m/Y - H:i') }}</p>
                            <p class="tag-small">{{ assignment.type|capitalize }}</p>
                        </div>
                        <div class="content row-spacebtwn">
                            <div class="task column-start-start">
                                <div class="details row-start">
                                    <p class="name">
                                        {{ assignment.title }}
                                    </p>
                                    <p class="subject">| {{ assignment.subject.name }}</p>
                                </div>
                                <p class="description">{{ assignment.description }}</p>

                                <p class="groupes">
                                    <span class="title">Groupes :</span>
                                    {% if assignment.groups|length > 0 %}
                                        {% for group in assignment.groups %}
                                            {{ group.name }}{% if not loop.last %} - {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        Aucun groupe
                                    {% endif %}
                                </p>
                            </div>
                            <p class="status row-start">
                                <span>{{ assignment.isCompleted ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-notch"></i>' }}</span>
                                {{ assignment.isCompleted ? 'Terminé' : 'En cours' }}
                            </p>
                        </div>

                    </div>
                {% endfor %}
            {% else %}
                <p>Aucune tâche trouvée.</p>
            {% endif %}
        </div>
    </main>



    <script>
        function filterAssignments() {
            let selectedSubject = document.getElementById("subjectSelect").value;
            let selectedGroup = document.getElementById("groupSelect").value;
            document.querySelectorAll(".assignment").forEach(assignment => {
                let subject = assignment.getAttribute("data-subject");
                let groups = assignment.getAttribute("data-groups").split(", ");
                let matchesSubject = !selectedSubject || subject === selectedSubject;
                let matchesGroup = !selectedGroup || groups.includes(selectedGroup);
                assignment.style.display = matchesSubject && matchesGroup ? "block" : "none";
            });
        }
    </script>
{% endblock %}